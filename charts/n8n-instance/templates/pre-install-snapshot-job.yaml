{{- if not .Values.isolatedDB }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-pre-install-snapshot
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "n8n-instance.labels" . | nindent 4 }}
    component: backup
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "n8n-instance.selectorLabels" . | nindent 8 }}
        component: backup
    spec:
      restartPolicy: OnFailure
      containers:
      - name: snapshot
        image: postgres:16
        command:
        - /bin/bash
        - -c
        - |
          set -e

          # Create timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          VERSION={{ .Values.n8nVersion }}
          BACKUP_FILE="/backups/n8n-${TIMESTAMP}-pre-v${VERSION}.sql"

          echo "Creating database snapshot before deploying version ${VERSION}..."

          # Wait for postgres to be ready
          until pg_isready -h {{ include "n8n-instance.dbHost" . }} -U {{ include "n8n-instance.dbUsername" . }}; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

          # Create backup
          PGPASSWORD={{ include "n8n-instance.dbPassword" . }} pg_dump \
            -h {{ include "n8n-instance.dbHost" . }} \
            -U {{ include "n8n-instance.dbUsername" . }} \
            -d {{ include "n8n-instance.dbDatabase" . }} \
            > "${BACKUP_FILE}"

          if [ -f "${BACKUP_FILE}" ]; then
            SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
            echo "Snapshot created successfully: ${BACKUP_FILE} (${SIZE})"
          else
            echo "ERROR: Snapshot creation failed"
            exit 1
          fi
        volumeMounts:
        - name: backup-storage
          mountPath: /backups
      volumes:
      - name: backup-storage
        persistentVolumeClaim:
          claimName: backup-storage
{{- end }}
